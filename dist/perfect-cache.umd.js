(function(h,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(h=typeof globalThis!="undefined"?globalThis:h||self,a(h.PerfectCache={}))})(this,function(h){"use strict";var M=Object.defineProperty,J=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var D=(h,a,d)=>a in h?M(h,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):h[a]=d,y=(h,a)=>{for(var d in a||(a={}))L.call(a,d)&&D(h,d,a[d]);if(I)for(var d of I(a))U.call(a,d)&&D(h,d,a[d]);return h},j=(h,a)=>J(h,G(a));var l=(h,a,d)=>(D(h,typeof a!="symbol"?a+"":a,d),d);var a={driver:"memory",prefix:"cache:"};function d(o){return{all:o=o||new Map,on:function(i,e){var t=o.get(i);t?t.push(e):o.set(i,[e])},off:function(i,e){var t=o.get(i);t&&(e?t.splice(t.indexOf(e)>>>0,1):o.set(i,[]))},emit:function(i,e){var t=o.get(i);t&&t.slice().map(function(r){r(e)}),(t=o.get("*"))&&t.slice().map(function(r){r(i,e)})}}}class E{constructor(){l(this,"mitt",new d)}$on(){return this.mitt.on.apply(this,arguments)}$off(){return this.mitt.off.apply(this,arguments)}$emit(){return this.mitt.emit.apply(this,arguments)}}const v={OK:Symbol("OK"),KEY_NOT_EXISTS:Symbol("KEY_NOT_EXISTS"),KEY_EXPIRED:Symbol("KEY_EXPIRED"),JSON_PARSE_ERROR:Symbol("JSON_PARSE_ERROR"),NX_SET_NOT_PERFORMED:Symbol("NX_SET_NOT_PERFORMED"),XX_SET_NOT_PERFORMED:Symbol("XX_SET_NOT_PERFORMED")};class g extends E{constructor(e={}){super();l(this,"opts");l(this,"isReady",!1);l(this,"prefix","cache:");this.opts=e,this.opts.prefix&&(this.prefix=this.opts.prefix),this.isReady=!1}__getRealKey(e){return`${this.prefix}${e}`}ready(e){setTimeout(()=>{this.isReady=!0,this.$emit("ready"),e&&typeof e=="function"&&e()},0)}keyValueGet(){throw new Error("please implement the keyValueGet method for this driver.")}keyValueSet(){throw new Error("please implement the keyValueSet method for this driver.")}existsKey(){throw new Error("please implement the existsKey method for this driver.")}removeItem(){throw new Error("please implement the removeItem method for this driver.")}async clear(){const e=await this.keys();for(const t of e)await this.removeItem(t);return Promise.resolve()}keys(){throw new Error("please implement the keys method for this driver.")}length(){return new Promise((e,t)=>{this.keys().then(r=>{e(r.length)}).catch(r=>{t(r)})})}getItem(e){return new Promise((t,r)=>{this.keyValueGet(e).then(s=>{s?s.expiredTimeAt?s.expiredTimeAt>Date.now()?s.maxAge?(s.expiredTimeAt=Date.now()+s.maxAge,this.keyValueSet(e,s).then(()=>t(s.value)).catch(n=>{r(n)})):t(s.value):(this.$emit("cacheExpired",e),t()):t(s.value):t()}).catch(s=>{r(s)})})}setItem(e,t,r={}){const{expiredTime:s,expiredTimeAt:n,maxAge:c,setOnlyNotExist:m=!1,setOnlyExist:f=!1}=r;let u,b;return s&&typeof s=="number"&&s>0&&(u=Date.now()+s),n&&typeof n=="number"&&n>0&&(u=n),u?u=Math.max(u,Date.now()):c&&typeof c=="number"&&c>0&&(u=Date.now()+c,b=c),new Promise((p,S)=>{m||f?this.existsKey(e).then(_=>{if(m&&_)return p(v.NX_SET_NOT_PERFORMED);if(f&&!_)return p(v.XX_SET_NOT_PERFORMED);this.keyValueSet(e,{value:t,expiredTimeAt:u,maxAge:b}).then(()=>p(v.OK)).catch(X=>{S(X)})}).catch(_=>{S(_)}):this.keyValueSet(e,{value:t,expiredTimeAt:u,maxAge:b}).then(()=>p(v.OK)).catch(_=>{S(_)})})}}class C extends g{constructor(i){super(i),this.ready()}keyValueGet(i){const e=localStorage.getItem(this.__getRealKey(i));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${i} json parse error`,e),t()}else t()})}keyValueSet(i,e){return new Promise((t,r)=>{try{localStorage.setItem(this.__getRealKey(i),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(i){return localStorage.getItem(this.__getRealKey(i))?Promise.resolve(!0):Promise.resolve(!1)}removeItem(i){return new Promise((e,t)=>{try{localStorage.removeItem(this.__getRealKey(i)),e()}catch(r){t(r)}})}keys(){const i=[];for(const e of Object.keys(localStorage))e.startsWith(this.prefix)&&i.push(e.replace(this.prefix,""));return Promise.resolve(i)}}l(C,"driver","localStorage");class O extends g{constructor(e){super(e);l(this,"data",new Map);this.ready()}keyValueGet(e){const t=this.data.get(this.__getRealKey(e));return new Promise(r=>{if(t)try{const s=JSON.parse(t);r(s)}catch{window.console.debug(`get key ${e} json parse error`,t),r()}else r()})}keyValueSet(e,t){return this.data.set(this.__getRealKey(e),JSON.stringify(t)),Promise.resolve()}existsKey(e){return this.data.has(this.__getRealKey(e))?Promise.resolve(!0):Promise.resolve(!1)}removeItem(e){return new Promise((t,r)=>{try{this.data.delete(this.__getRealKey(e)),t()}catch(s){r(s)}})}keys(){const e=Array.from(this.data.keys()).map(t=>t.replace(this.prefix,""));return Promise.resolve(e)}clear(){return this.data.clear(),Promise.resolve()}length(){return Promise.resolve(this.data.size)}}l(O,"driver","memory");class $ extends g{constructor(i){super(i),this.ready()}keyValueGet(i){const e=sessionStorage.getItem(this.__getRealKey(i));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${i} json parse error`,e),t()}else t()})}keyValueSet(i,e){return new Promise((t,r)=>{try{sessionStorage.setItem(this.__getRealKey(i),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(i){return sessionStorage.getItem(this.__getRealKey(i))?Promise.resolve(!0):Promise.resolve(!1)}removeItem(i){return new Promise((e,t)=>{try{sessionStorage.removeItem(this.__getRealKey(i)),e()}catch(r){t(r)}})}keys(){const i=[];for(const e of Object.keys(sessionStorage))e.startsWith(this.prefix)&&i.push(e.replace(this.prefix,""));return Promise.resolve(i)}}l($,"driver","sessionStorage");/*! js-cookie v3.0.1 | MIT */function N(o){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var t in e)o[t]=e[t]}return o}var T={read:function(o){return o[0]==='"'&&(o=o.slice(1,-1)),o.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(o){return encodeURIComponent(o).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function R(o,i){function e(r,s,n){if(typeof document!="undefined"){n=N({},i,n),typeof n.expires=="number"&&(n.expires=new Date(Date.now()+n.expires*864e5)),n.expires&&(n.expires=n.expires.toUTCString()),r=encodeURIComponent(r).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var c="";for(var m in n)!n[m]||(c+="; "+m,n[m]!==!0&&(c+="="+n[m].split(";")[0]));return document.cookie=r+"="+o.write(s,r)+c}}function t(r){if(!(typeof document=="undefined"||arguments.length&&!r)){for(var s=document.cookie?document.cookie.split("; "):[],n={},c=0;c<s.length;c++){var m=s[c].split("="),f=m.slice(1).join("=");try{var u=decodeURIComponent(m[0]);if(n[u]=o.read(f,u),r===u)break}catch{}}return r?n[r]:n}}return Object.create({set:e,get:t,remove:function(r,s){e(r,"",N({},s,{expires:-1}))},withAttributes:function(r){return R(this.converter,N({},this.attributes,r))},withConverter:function(r){return R(N({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(i)},converter:{value:Object.freeze(o)}})}var x=R(T,{path:"/"});class V extends g{constructor(i){super(i),this.ready()}keyValueGet(i){const e=x.get(this.__getRealKey(i));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${i} json parse error`,e),t()}else t()})}keyValueSet(i,e){return new Promise((t,r)=>{try{x.set(this.__getRealKey(i),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(i){return x.get(this.__getRealKey(i))?Promise.resolve(!0):Promise.resolve(!1)}removeItem(i){return new Promise((e,t)=>{try{x.remove(this.__getRealKey(i)),e()}catch(r){t(r)}})}keys(){const i=x.get(),e=[];for(const t of Object.keys(i))t.startsWith(this.prefix)&&e.push(t.replace(this.prefix,""));return Promise.resolve(e)}}l(V,"driver","cookie");class K extends g{constructor(e){var t,r,s;super(e);l(this,"dbName","perfect-cache");l(this,"objectStoreName","perfect-cache");l(this,"dbVersion");l(this,"dbConnection");(t=this.opts)!=null&&t.dbName&&(this.dbName=this.opts.dbName),(r=this.opts)!=null&&r.objectStoreName&&(this.objectStoreName=this.opts.objectStoreName),(s=this.opts)!=null&&s.dbVersion&&(this.dbVersion=this.opts.dbVersion),this.init().catch(()=>{this.dbConnection?this.upgradeToVersion(this.dbConnection.version+1):this.upgradeToVersion()})}init(){return this.connectDB().then(()=>this.initObjectStore())}upgradeToVersion(e){this.dbConnection?(this.dbConnection.close(),this.dbVersion=e):this.dbVersion=void 0,window.console.debug(`Database ${this.dbName} store ${this.objectStoreName} is upgrading to version ${this.dbVersion}...`),this.init().then(()=>{window.console.debug(`Database ${this.dbName} store ${this.objectStoreName} version upgraded to ${this.dbVersion} success.`)}).catch(t=>{window.console.error(`Database ${this.dbName} store ${this.objectStoreName} version upgraded to ${this.dbVersion} failed.`,t)})}connectDB(){return new Promise((e,t)=>{const r=window.indexedDB.open(this.dbName,this.dbVersion);r.onerror=s=>{window.console.error(`Database ${this.dbName} store ${this.objectStoreName} init version ${this.dbVersion} occurs error`,s),t(s)},r.onsuccess=()=>{this.dbConnection=r.result,this.dbVersion=this.dbConnection.version,window.console.debug(`Database ${this.dbName} store ${this.objectStoreName} version ${this.dbConnection.version} initialised.`),this.dbConnection.onversionchange=s=>{window.console.debug(`The version of this database ${this.dbName} store ${this.objectStoreName} has changed from ${s.oldVersion} to ${s.newVersion}`),this.upgradeToVersion(s.newVersion)},e(this.dbConnection)},r.onupgradeneeded=s=>{this.dbConnection=s.target.result,this.dbVersion=this.dbConnection.version,window.console.debug(`Database ${this.dbName} store ${this.objectStoreName} upgrade needed as oldVersion is ${s.oldVersion} and newVersion is ${s.newVersion}.`),e(this.dbConnection)}})}initObjectStore(){return new Promise((e,t)=>{if(this.dbConnection)if(this.dbConnection.objectStoreNames.contains(this.objectStoreName))this.ready(e);else{window.console.debug(`ObjectStore ${this.objectStoreName} is not exists, now creating it!`);const r=this.dbConnection.createObjectStore(this.objectStoreName,{keyPath:"key"});r.transaction.oncomplete=s=>{window.console.debug(`ObjectStore ${this.objectStoreName} is created now.`),this.ready(e)}}else{const r=new Error(`Database ${this.dbName} connection is not initialised.`);t(r)}})}keyValueGet(e){return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(this.__getRealKey(e));s.onerror=()=>{window.console.error("Database get occurs error",s.result),r(s.result)},s.onsuccess=()=>{var n;t((n=s.result)==null?void 0:n.value)}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}keyValueSet(e,t){return new Promise((r,s)=>{if(this.dbConnection){const n=this.dbConnection.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName).put({key:this.__getRealKey(e),value:t});n.onerror=()=>{window.console.error("Database put occurs error",n.result),s(n.result)},n.onsuccess=()=>{var c;r((c=n.result)==null?void 0:c.value)}}else{const n=new Error(`Database ${this.dbName} connection is not initialised.`);s(n)}})}existsKey(e){return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).count(this.__getRealKey(e));s.onerror=()=>{window.console.error("Database count occurs error",s.result),r(s.result)},s.onsuccess=()=>{t(!!s.result)}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}removeItem(e){return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName).delete(this.__getRealKey(e));s.onerror=()=>{window.console.error("Database delete occurs error",s.result),r(s.result)},s.onsuccess=()=>{t()}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}keys(){const e=[];return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).openCursor();s.onerror=()=>{window.console.error("Database openCursor occurs error",s.result),r(s.result)},s.onsuccess=n=>{var c=n.target.result;c?(c.key.startsWith(this.prefix)&&e.push(c.key.replace(this.prefix,"")),c.continue()):t(e)}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}}l(K,"driver","indexedDB");const w={};for(const o of[O,C,$,V,K])w[o.driver]=o;const k={},F=o=>{if(o instanceof g.constructor)if(o.driver&&typeof o.driver=="string")k[o.driver]=o;else throw new Error("please input the driver name.");else throw new Error("the store driver class must be subclass of BaseStore.")},P=()=>{let o=["memory"];return(window==null?void 0:window.localStorage)&&w.localStorage&&o.push("localStorage"),(window==null?void 0:window.sessionStorage)&&w.sessionStorage&&o.push("sessionStorage"),(window==null?void 0:window.document)&&"cookie"in(window==null?void 0:window.document)&&w.cookie&&o.push("cookie"),(window==null?void 0:window.indexedDB)&&w.indexedDB&&o.push("indexedDB"),o=o.concat(Object.keys(k)),o},A=o=>w[o]||k[o];class B extends E{constructor(e,t){super();l(this,"opts");l(this,"__init",!1);l(this,"driver");l(this,"store");l(this,"keyFallbacks",[]);l(this,"keyRegexFallbacks",[]);const r=P();if(!e&&!t)t=y({},a);else if(e)if(r.includes(e))Object.prototype.toString.call(t)==="[object Object]"?t=y(j(y({},a),{driver:e}),t):t=j(y({},a),{driver:e});else if(Object.prototype.toString.call(e)==="[object Object]"&&r.includes(e.driver))t=y(y({},a),e);else throw new Error("please input the correct driver param as the first param or in the opts params.");else throw new Error("please input the driver as first param.");if(t&&t.driver)this.opts=t,this.initDriver();else throw new Error("please input the driver as first param.")}initDriver(){const e=P();if(this.opts&&this.opts.driver&&e.includes(this.opts.driver)){this.__init=!1;const t=A(this.opts.driver);this.store=new t(this.opts),this.store.$on("ready",()=>{this.__init=!0,this.driver=this.opts.driver,this.$emit("ready")}),this.store.$on("cacheExpired",r=>{this.$emit("cacheExpired",r)})}}setDriver(e){this.opts.driver=e,this.initDriver()}existsKey(){return this.store.existsKey.apply(this.store,arguments)}getItem(e,t={}){const{defaultVal:r,withFallback:s=!0,refreshCache:n=!0}=t;return new Promise(async(c,m)=>{const f=await this.store.getItem(e),u=f==null||f==="";if(u&&s){const b=this.__getFallbackByKey(e);if(b){const p=await b.fallback(e),S=p==null||p==="";n&&!S&&await this.store.setItem(e,p,{expiredTime:b.expiredTime,maxAge:b.maxAge}),c(S&&r!==void 0?r:p)}else c(r===void 0?f:r)}else c(u&&r!==void 0?r:f)})}setItem(){return this.store.setItem.apply(this.store,arguments)}removeItem(){return this.store.removeItem.apply(this.store,arguments)}clear(){return this.store.clear.apply(this.store,arguments)}keys(){return this.store.keys.apply(this.store,arguments)}length(){return this.store.length.apply(this.store,arguments)}fallbackKey(e,t,r={}){const{expiredTime:s,maxAge:n}=r;if(typeof e=="string"){if(t instanceof Function)return this.keyFallbacks.push({key:e,expiredTime:s,maxAge:n,fallback:t});throw new Error("please input the fallback as type [Function]")}if(e instanceof RegExp){if(t instanceof Function)return this.keyRegexFallbacks.push({regex:e,expiredTime:s,maxAge:n,fallback:t});throw new Error("please input the fallback as type [Function]")}}__getFallbackByKey(e){let t=this.keyFallbacks.find(r=>r.key===e);return t||(t=this.keyRegexFallbacks.find(r=>r.regex.test(e)),t)}}h.BaseStore=g,h.EventListener=E,h.PerfectCache=B,h.StoreResult=v,h.getSupportedDriverList=P,h.registerStore=F,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
