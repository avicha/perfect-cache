(function(c,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(c=typeof globalThis!="undefined"?globalThis:c||self,a(c.PerfectCache={}))})(this,function(c){"use strict";var M=Object.defineProperty,J=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var P=(c,a,d)=>a in c?M(c,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[a]=d,S=(c,a)=>{for(var d in a||(a={}))L.call(a,d)&&P(c,d,a[d]);if(I)for(var d of I(a))U.call(a,d)&&P(c,d,a[d]);return c},K=(c,a)=>J(c,G(a));var l=(c,a,d)=>(P(c,typeof a!="symbol"?a+"":a,d),d);var a={driver:"memory",prefix:"cache:"};function d(i){return{all:i=i||new Map,on:function(o,e){var t=i.get(o);t?t.push(e):i.set(o,[e])},off:function(o,e){var t=i.get(o);t&&(e?t.splice(t.indexOf(e)>>>0,1):i.set(o,[]))},emit:function(o,e){var t=i.get(o);t&&t.slice().map(function(r){r(e)}),(t=i.get("*"))&&t.slice().map(function(r){r(o,e)})}}}class R{constructor(){l(this,"mitt",new d)}$on(){return this.mitt.on.apply(this,arguments)}$off(){return this.mitt.off.apply(this,arguments)}$emit(){return this.mitt.emit.apply(this,arguments)}}const x={OK:Symbol("OK"),KEY_NOT_EXISTS:Symbol("KEY_NOT_EXISTS"),KEY_EXPIRED:Symbol("KEY_EXPIRED"),JSON_PARSE_ERROR:Symbol("JSON_PARSE_ERROR"),NX_SET_NOT_PERFORMED:Symbol("NX_SET_NOT_PERFORMED"),XX_SET_NOT_PERFORMED:Symbol("XX_SET_NOT_PERFORMED")};class y extends R{constructor(e={}){super();l(this,"opts");l(this,"isReady",!1);l(this,"prefix","cache:");this.opts=e,this.opts.prefix&&(this.prefix=this.opts.prefix),this.isReady=!1}__getRealKey(e){return`${this.prefix}${e}`}ready(e){setTimeout(()=>{this.isReady=!0,this.$emit("ready"),e&&typeof e=="function"&&e()},0)}keyValueGet(){throw new Error("please implement the keyValueGet method for this driver.")}keyValueSet(){throw new Error("please implement the keyValueSet method for this driver.")}existsKey(){throw new Error("please implement the existsKey method for this driver.")}getItem(e){return new Promise((t,r)=>{this.keyValueGet(e).then(s=>{s?s.expiredTimeAt?s.expiredTimeAt>Date.now()?s.maxAge?(s.expiredTimeAt=Date.now()+s.maxAge,this.keyValueSet(e,s).then(()=>t(s.value)).catch(n=>{r(n)})):t(s.value):(this.$emit("cacheExpired",e),t()):t(s.value):t()}).catch(s=>{r(s)})})}setItem(e,t,r={}){const{expiredTime:s,expiredTimeAt:n,maxAge:u,setOnlyNotExist:f=!1,setOnlyExist:m=!1}=r;let h,g;return s&&typeof s=="number"&&s>0&&(h=Date.now()+s),n&&typeof n=="number"&&n>0&&(h=n),h?h=Math.max(h,Date.now()):u&&typeof u=="number"&&u>0&&(h=Date.now()+u,g=u),new Promise((p,b)=>{f||m?this.existsKey(e).then(_=>{if(f&&_)return p(x.NX_SET_NOT_PERFORMED);if(m&&!_)return p(x.XX_SET_NOT_PERFORMED);this.keyValueSet(e,{value:t,expiredTimeAt:h,maxAge:g}).then(()=>p(x.OK)).catch(X=>{b(X)})}).catch(_=>{b(_)}):this.keyValueSet(e,{value:t,expiredTimeAt:h,maxAge:g}).then(()=>p(x.OK)).catch(_=>{b(_)})})}}class j extends y{constructor(o){super(o),this.ready()}keyValueGet(o){const e=localStorage.getItem(this.__getRealKey(o));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${o} json parse error`,e),t()}else t()})}keyValueSet(o,e){return new Promise((t,r)=>{try{localStorage.setItem(this.__getRealKey(o),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(o){return localStorage.getItem(this.__getRealKey(o))?Promise.resolve(!0):Promise.resolve(!1)}}l(j,"driver","localStorage");class k extends y{constructor(e){super(e);l(this,"data",new Map);this.ready()}keyValueGet(e){const t=this.data.get(this.__getRealKey(e));return new Promise(r=>{if(t)try{const s=JSON.parse(t);r(s)}catch{window.console.debug(`get key ${e} json parse error`,t),r()}else r()})}keyValueSet(e,t){return this.data.set(this.__getRealKey(e),JSON.stringify(t)),Promise.resolve()}existsKey(e){return this.data.has(this.__getRealKey(e))?Promise.resolve(!0):Promise.resolve(!1)}}l(k,"driver","memory");class C extends y{constructor(o){super(o),this.ready()}keyValueGet(o){const e=sessionStorage.getItem(this.__getRealKey(o));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${o} json parse error`,e),t()}else t()})}keyValueSet(o,e){return new Promise((t,r)=>{try{sessionStorage.setItem(this.__getRealKey(o),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(o){return sessionStorage.getItem(this.__getRealKey(o))?Promise.resolve(!0):Promise.resolve(!1)}}l(C,"driver","sessionStorage");/*! js-cookie v3.0.1 | MIT */function E(i){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var t in e)i[t]=e[t]}return i}var F={read:function(i){return i[0]==='"'&&(i=i.slice(1,-1)),i.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(i){return encodeURIComponent(i).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function v(i,o){function e(r,s,n){if(typeof document!="undefined"){n=E({},o,n),typeof n.expires=="number"&&(n.expires=new Date(Date.now()+n.expires*864e5)),n.expires&&(n.expires=n.expires.toUTCString()),r=encodeURIComponent(r).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var u="";for(var f in n)!n[f]||(u+="; "+f,n[f]!==!0&&(u+="="+n[f].split(";")[0]));return document.cookie=r+"="+i.write(s,r)+u}}function t(r){if(!(typeof document=="undefined"||arguments.length&&!r)){for(var s=document.cookie?document.cookie.split("; "):[],n={},u=0;u<s.length;u++){var f=s[u].split("="),m=f.slice(1).join("=");try{var h=decodeURIComponent(f[0]);if(n[h]=i.read(m,h),r===h)break}catch{}}return r?n[r]:n}}return Object.create({set:e,get:t,remove:function(r,s){e(r,"",E({},s,{expires:-1}))},withAttributes:function(r){return v(this.converter,E({},this.attributes,r))},withConverter:function(r){return v(E({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(o)},converter:{value:Object.freeze(i)}})}var N=v(F,{path:"/"});class T extends y{constructor(o){super(o),this.ready()}keyValueGet(o){const e=N.get(this.__getRealKey(o));return new Promise(t=>{if(e)try{const r=JSON.parse(e);t(r)}catch{window.console.debug(`get key ${o} json parse error`,e),t()}else t()})}keyValueSet(o,e){return new Promise((t,r)=>{try{N.set(this.__getRealKey(o),JSON.stringify(e)),t()}catch(s){r(s)}})}existsKey(o){return N.get(this.__getRealKey(o))?Promise.resolve(!0):Promise.resolve(!1)}}l(T,"driver","cookie");class V extends y{constructor(e){var t,r,s;super(e);l(this,"dbName","perfect-cache");l(this,"objectStoreName","perfect-cache");l(this,"dbVersion",1);l(this,"dbConnection");(t=this.opts)!=null&&t.dbName&&(this.dbName=this.opts.dbName),(r=this.opts)!=null&&r.objectStoreName&&(this.objectStoreName=this.opts.objectStoreName),(s=this.opts)!=null&&s.dbVersion&&(this.dbVersion=this.opts.dbVersion),this.connectDB().then(()=>{this.initObjectStore()})}connectDB(){return new Promise((e,t)=>{const r=window.indexedDB.open(this.dbName,this.dbVersion);r.onerror=()=>{window.console.error(`Database ${this.dbName} init occurs error`,r.result),t(r.result)},r.onsuccess=()=>{this.dbConnection=r.result,window.console.debug(`Database ${this.dbName} initialised.`),e(this.dbConnection)},r.onupgradeneeded=s=>{this.dbConnection=s.target.result,window.console.debug("Database version upgraded success."),e(this.dbConnection)}})}initObjectStore(){return new Promise((e,t)=>{if(this.dbConnection)if(this.dbConnection.objectStoreNames.contains(this.objectStoreName))this.ready(e);else{window.console.debug(`ObjectStore ${this.objectStoreName} is not exists, now creating it!`);const r=this.dbConnection.createObjectStore(this.objectStoreName,{keyPath:"key"});r.transaction.oncomplete=s=>{window.console.debug(`ObjectStore ${this.objectStoreName} is created now.`),this.ready(e)}}else{const r=new Error(`Database ${this.dbName} connection is not initialised.`);t(r)}})}keyValueGet(e){return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(this.__getRealKey(e));s.onerror=()=>{window.console.error("Database keyValueGet occurs error",s.result),r(s.result)},s.onsuccess=()=>{var n;t((n=s.result)==null?void 0:n.value)}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}keyValueSet(e,t){return new Promise((r,s)=>{if(this.dbConnection){const n=this.dbConnection.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName).put({key:this.__getRealKey(e),value:t});n.onerror=()=>{window.console.error("Database keyValueSet occurs error",n.result),s(n.result)},n.onsuccess=()=>{var u;r((u=n.result)==null?void 0:u.value)}}else{const n=new Error(`Database ${this.dbName} connection is not initialised.`);s(n)}})}existsKey(e){return new Promise((t,r)=>{if(this.dbConnection){const s=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).count(this.__getRealKey(e));s.onerror=()=>{window.console.error("Database existsKey occurs error",s.result),r(s.result)},s.onsuccess=()=>{t(!!s.result)}}else{const s=new Error(`Database ${this.dbName} connection is not initialised.`);r(s)}})}}l(V,"driver","indexedDB");const w={};for(const i of[k,j,C,T,V])w[i.driver]=i;const D={},$=i=>{if(i instanceof y.constructor)if(i.driver&&typeof i.driver=="string")D[i.driver]=i;else throw new Error("please input the driver name.");else throw new Error("the store driver class must be subclass of BaseStore.")},O=()=>{let i=["memory"];return(window==null?void 0:window.localStorage)&&w.localStorage&&i.push("localStorage"),(window==null?void 0:window.sessionStorage)&&w.sessionStorage&&i.push("sessionStorage"),(window==null?void 0:window.document)&&"cookie"in(window==null?void 0:window.document)&&w.cookie&&i.push("cookie"),(window==null?void 0:window.indexedDB)&&w.indexedDB&&i.push("indexedDB"),i=i.concat(Object.keys(D)),i},A=i=>w[i]||D[i];class B extends R{constructor(e,t){super();l(this,"opts");l(this,"__init",!1);l(this,"driver");l(this,"store");l(this,"keyFallbacks",[]);l(this,"keyRegexFallbacks",[]);const r=O();if(!e&&!t)t=S({},a);else if(e)if(r.includes(e))Object.prototype.toString.call(t)==="[object Object]"?t=S(K(S({},a),{driver:e}),t):t=K(S({},a),{driver:e});else if(Object.prototype.toString.call(e)==="[object Object]"&&r.includes(e.driver))t=S(S({},a),e);else throw new Error("please input the correct driver param as the first param or in the opts params.");else throw new Error("please input the driver as first param.");if(t&&t.driver)this.opts=t,this.initDriver();else throw new Error("please input the driver as first param.")}initDriver(){const e=O();if(this.opts&&this.opts.driver&&e.includes(this.opts.driver)){this.__init=!1;const t=A(this.opts.driver);this.store=new t(this.opts),this.store.$on("ready",()=>{this.__init=!0,this.driver=this.opts.driver,this.$emit("ready")}),this.store.$on("cacheExpired",r=>{this.$emit("cacheExpired",r)})}}setDriver(e){this.opts.driver=e,this.initDriver()}existsKey(){return this.store.existsKey.apply(this.store,arguments)}getItem(e,t={}){const{defaultVal:r,withFallback:s=!0,refreshCache:n=!0}=t;return new Promise(async(u,f)=>{const m=await this.store.getItem(e),h=m==null||m==="";if(h&&s){const g=this.__getFallbackByKey(e);if(g){const p=await g.fallback(e),b=p==null||p==="";n&&!b&&await this.store.setItem(e,p,{expiredTime:g.expiredTime,maxAge:g.maxAge}),u(b&&r!==void 0?r:p)}else u(r===void 0?m:r)}else u(h&&r!==void 0?r:m)})}setItem(){return this.store.setItem.apply(this.store,arguments)}fallbackKey(e,t,r={}){const{expiredTime:s,maxAge:n}=r;if(typeof e=="string"){if(t instanceof Function)return this.keyFallbacks.push({key:e,expiredTime:s,maxAge:n,fallback:t});throw new Error("please input the fallback as type [Function]")}if(e instanceof RegExp){if(t instanceof Function)return this.keyRegexFallbacks.push({regex:e,expiredTime:s,maxAge:n,fallback:t});throw new Error("please input the fallback as type [Function]")}}__getFallbackByKey(e){let t=this.keyFallbacks.find(r=>r.key===e);return t||(t=this.keyRegexFallbacks.find(r=>r.regex.test(e)),t)}}c.BaseStore=y,c.EventListener=R,c.PerfectCache=B,c.StoreResult=x,c.getSupportedDriverList=O,c.registerStore=$,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
